<!--
Copyright Â© MyScript.
LICENSE: github.com/MyScriptWebComponents/myscript-math/blob/master/LICENSE
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-icons/av-icons.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../paper-toolbar/paper-toolbar.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../myscript-ink-paper/myscript-ink-paper.html">
<!--
The `myscript-math` is a turnkey solution for those who need to quickly implement MyScript Math recognition.

##### Example

    <myscript-math application-key="XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX" hmac-key="XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX"></myscript-math>

@group MyScript Elements
@element myscript-math
@blurb MyScript HTML5 Math Element to help developers integrate math handwriting recognition.
@status alpha
@homepage http://myscriptwebcomponents.github.io/myscript-math

@demo demo/index.html Basic Demo
-->
<dom-module id="myscript-math">
    <style>
        paper-toolbar {
            --paper-toolbar-background: #00a7cf;
        }
    </style>
    <template>
        <paper-toolbar>
            <paper-icon-button id="delete" icon="delete"
                               on-tap="_delete">
            </paper-icon-button>
            <paper-icon-button id="undo" icon="undo"
                               on-tap="_undo" disabled="{{!hasUndo}}">
            </paper-icon-button>
            <paper-icon-button id="redo" icon="redo"
                               on-tap="_redo" disabled="{{!hasRedo}}">
            </paper-icon-button>
            <paper-icon-button id="info" icon="info"
                               on-tap="_info">
            </paper-icon-button>
        </paper-toolbar>
        <paper-dialog id="infodialog" modal>
            <h3>About</h3>

            <p align='justify'>Write an equation in the canvas zone. <br> After a short timeout (a second) the
                recognition will be launched and the result will be shown on the result field. <br> You
                can clear the writing space by clicking on the garbage can icon in the top left corner.</p>

            <div class="buttons">
                <paper-button dialog-confirm autofocus>Close</paper-button>
            </div>
        </paper-dialog>
        <myscript-ink-paper url="{{url}}"
                            type="MATH"
                            application-key="{{ applicationKey }}"
                            hmac-key="{{ hmacKey }}"
                            width="{{ computedWidth }}"
                            height="{{ computedHeight }}"
                            timeout="{{ timeout }}"
                            on-result="_onRecognized"
                            on-error="_onError"
                            on-changed="_onChanged">
        </myscript-ink-paper>
    </template>
</dom-module>

<script>
    (function () {
        Polymer({
            is: 'myscript-math',
            properties: {
                /**
                 * Url to use for MyScript handwriting recognition server
                 *
                 * @attribute url
                 * @type String
                 */
                url: String,
                /**
                 * The myscript-ink-paper width
                 *
                 * <b>Warning</b>: This is <b>not</b> the myscript-math width, but the canvas one.
                 *
                 * @attribute width
                 * @type Number
                 */
                width: {
                    type: Number,
                    notify: true
                },
                /**
                 * The myscript-ink-paper height
                 *
                 * <b>Warning</b>: This is <b>not</b> the myscript-math height, but the canvas one.
                 *
                 * @attribute height
                 * @type Number
                 */
                height: {
                    type: Number,
                    notify: true
                },
                /**
                 * Recognition timeout
                 *
                 * @attribute timeout
                 * @type Number
                 * @default 2000
                 */
                timeout: {
                    type: Number,
                    notify: true
                },
                /**
                 * Application key to use for recognition on MyScript handwriting recognition server.<br>
                 * You have to create your own MyScript Developer account at http://dev.myscript.com and then generate your application key at http://cloud.myscript.com.<br>
                 * <b>Warning</b>: This parameter is <b>mandatory</b> and it's value should be a string.
                 *
                 * @attribute application-key
                 * @type String
                 */
                applicationKey: {
                    type: String,
                    notify: true
                },
                /**
                 * HMAC key to use for recognition on MyScript handwriting recognition server.<br>
                 * You have to create your own HMAC key corresponding to your own application key in your account at http://cloud.myscript.com.<br>
                 *
                 * <b>Warning</b>: This parameter may be <b>mandatory</b> if HMAC signature security is enable for your application. The value should be a string.
                 *
                 * @attribute hmac-key
                 * @type String
                 */
                hmacKey: {
                    type: String,
                    notify: true
                },
                hasUndo: {
                    type: Boolean,
                    notify: true,
                    value: false
                },
                hasRedo: {
                    type: Boolean,
                    notify: true,
                    value: false
                }
            },
            behaviors: [
                Polymer.IronResizableBehavior
            ],
            listeners: {
                'iron-resize': '_onResize'
            },
            _delete: function () {
                this._inkPaper.clear();
            },
            _undo: function () {
                this._inkPaper.undo();
            },
            _redo: function () {
                this._inkPaper.redo();
            },
            _info: function () {
                this.$.infodialog.toggle();
            },
            _recognize: function () {
                this._inkPaper.recognize();
            },
            _onRecognized: function (e) {
                var result = e.detail;
                var resultElements = result.getMathDocument().getResultElements();
                for (var res in resultElements) {
                    if (resultElements[res] instanceof MyScript.MathLaTexResultElement) {
                        this.fire('latex', resultElements[res].getValue());
                    } else if (resultElements[res] instanceof MyScript.MathMathMLResultElement) {
                        this.fire('mathml', resultElements[res].getValue());
                    } else if (resultElements[res] instanceof MyScript.MathSymbolTreeResultElement) {
                        this.fire('symboltree', resultElements[res].getRoot());
                    }
                }
            },
            _onError: function (e) {
                var result = e.detail;
            },
            _onChanged: function (e) {
                if (e.detail) {
                    this.hasUndo = e.detail.hasUndo;
                    this.hasRedo = e.detail.hasRedo;
                }
            },
            _onResize: function () {
                if (this._inkPaper) {
                    if (!this.width && (this.parent.offsetWidth > 0)) {
                        this.computedWidth = this.parent.offsetWidth;
                    } else {
                        this.computedWidth = this.width;
                    }

                    if (!this.height && (this.parent.offsetHeight > 0)) {
                        this.computedHeight = this.parent.offsetHeight;
                        for (var i in this.parent.children) {
                            if (this.parent.children[i].offsetHeight) {
                                this.computedHeight -= this.parent.children[i].offsetHeight;
                            }
                        }
                    } else {
                        this.computedHeight = this.height;
                    }
                }
            },
            get parent() {
                if (this.parentNode.nodeType === Node.DOCUMENT_FRAGMENT_NODE) {
                    return this.parentNode.host;
                }
                return this.parentNode;
            },
            attached: function () {
                this.async(this.notifyResize, 1);
            },
            ready: function () {
                this._inkPaper = this.querySelector('myscript-ink-paper');
            }
        });

    })();
</script>
